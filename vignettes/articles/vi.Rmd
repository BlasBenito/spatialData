---
title: "VI: Vegetation Index"
output:
  rmarkdown::html_document:
    toc: true
    toc_title: "Contents"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  eval = TRUE,
  collapse = TRUE,
  comment = "#>",
  out.width = "100%"
)
```

## Overview

The `vi` dataset contains several thousand records of Normalized Difference Vegetation Index (NDVI) with different encodings (see `vi_responses`) and a large set of numeric and categorical predictors.

It's main features are:

- *Complete case study* - No missing values, clean data ready for analysis.
- *Global scope* - 6 continents, all major climate zones, 12 biomes.
- *Scale considerations* - Supports regional, continental, and global analyses.
- *Grouped/stratified analysis* - Multiple hierarchical groupings available.

This dataset was built to support a wide range of analytical approaches:

**Response Variable Modeling**

- *Linear regression* - `vi_numeric` (continuous 0.03-0.82).
- *Count models* (Poisson, negative binomial) - `vi_counts` (integer 30-820).
- *Binary classification / logistic regression* - `vi_binomial` (0/1).
- *Ordinal regression* - `vi_factor` (ordered: very_low â†’ very_high).
- *Multi-class classification* - `vi_categorical` / `vi_factor` (5 levels).

**Statistical and Machine Learning Methods**

- *Multicollinearity selection* - Many predictor sets with mean/max/min/range patterns (e.g., `temperature_*`, `rainfall_*`, `swi_*`).
- *Variable importance / feature selection* - 50+ numeric predictors.
- *Dimensionality reduction* (PCA, UMAP) - High-dimensional predictor space.
- *Random forests / gradient boosting* - Mixed numeric and categorical predictors.
- *Mixed-effects models* - Natural grouping by continent, biome, climate zone.

**Spatial Analysis**

- *Spatial thinning* - 9,265 unique global coordinates.
- *Spatial interpolation* (kriging, IDW) - Global coverage with continuous response.
- *Spatial cross-validation* - Stratify by continent, region, biome, or climate.
- *Spatial autocorrelation analysis* - Dense enough for variogram estimation.
- *Geographically weighted regression* (GWR) - Explore spatial non-stationarity.

**Ecological and Environmental Modeling**

- *Species distribution modeling* (SDM) analogues - using `vi_binomial` as repsonse.
- *Climate-vegetation relationships* - Rich climate predictors vs. vegetation index.
- *Soil-vegetation interactions* - Multiple soil variables available.


## Setup

The following R libraries are required to run this tutorial:

```{r, message = FALSE, warning = FALSE, echo = FALSE}
library(spatialData)
library(sf)
library(mapview)
library(DT)
library(dplyr)
library(spatialRF)
library(collinear)
library(viridis)
```

The code below loads the example data.

```{r setup}
data(
  vi,
  vi_responses,
  vi_predictors,
  package = "spatialData"
  )
```

## Data Structure

The dataset is an `sf` data frame with `r nrow(vi)` rows and `r ncol(vi)` columns, and no empty data. The first 100 records and all columns but `geometry` are shown below.

```{r}
DT::datatable(
  data = head(sf::st_drop_geometry(vi), n = 100),
  rownames = FALSE
  )
```

The spatial distribution of the data is irregular, and excludes regions with little to no vegetation activity (`vi$vi_numeric > 0`).


```{r}
mapview::mapview(
  vi,
  zcol = "vi_numeric",
  layer.name = "vi"
)
```



## Response Variables

The dataset provides **5 different encodings** (see `vi_responses`) of the same underlying vegetation index, enabling different modeling approaches:

| Variable | Type | Description | Use Case |
|----------|------|-------------|----------|
| `vi_numeric` | Continuous (0-1) | Raw NDVI values | Linear regression, GAM |
| `vi_counts` | Integer | `vi_numeric * 1000` as integer | Poisson/negative binomial regression |
| `vi_binomial` | Binary (0/1) | Thresholded to 0 or 1 | Logistic regression, classification |
| `vi_categorical` | Character | 5 categories based on quantiles | Multinomial models |
| `vi_factor` | Factor | `vi_categorical` as ordered factor | Ordinal regression |

## Predictor Variables

The dataset includes **58 predictor variables from 11 datasources**, of which 47 are numeric and 11 are categorical.

```{r}
vi |> 
  sf::st_drop_geometry() |> 
  dplyr::select(
    dplyr::all_of(vi_predictors)
  ) |> 
  head(n = 5) |> 
  dplyr::glimpse()
```

## Example Usage

### Selection of Numeric Predictors

The `vi_predictors` vector contains both numeric and categorical variables. Before multicollinearity analysis, we extract only the numeric predictors using `collinear::identify_numeric_variables()`.

```{r}
vi_predictors_numeric <- collinear::identify_numeric_variables(
    df = sf::st_drop_geometry(vi),
    predictors = vi_predictors
  )$valid

vi_predictors_numeric
```

### Multicollinearity Filtering

Many predictors in this dataset are highly correlated (e.g., `temperature_mean`, `temperature_max`, `temperature_min`). The `collinear::collinear()` function selects a non-redundant subset that maximizes predictive power for the response variable.

```{r}
predictors_selection <- collinear::collinear(
  df = vi,
  responses = "vi_numeric",
  predictors = vi_predictors_numeric,
  f = collinear::f_numeric_rf,
  quiet = TRUE
)

predictors_selection$vi_numeric$selection
```

### Scatterplot

Before modeling, we visualize the relationship between the response and each selected predictor. The loess smoothers help identify non-linear patterns.

```{r, fig.width=8, fig.height=7, warning = FALSE, message = FALSE}
spatialRF::plot_training_df(
  data = vi,
  dependent.variable.name = "vi_numeric",
  predictor.variable.names = predictors_selection$vi_numeric$selection,
  point.color = viridis::viridis(n = 100),
  method = "loess",
  ncol = 3
)
```

### Random Forest Model

We fit a random forest model using the `spatialRF` package. This model predicts `vi_numeric` from the selected predictors without considering spatial structure.

```{r}
m <- spatialRF::rf(
  data = sf::st_drop_geometry(vi),
  dependent.variable.name = "vi_numeric",
  predictor.variable.names = predictors_selection$vi_numeric$selection,
  verbose = FALSE
)
```

### Residuals Diagnostics

Residual diagnostics help assess model fit. We look for homoscedasticity (constant variance) and normality of residuals.

```{r, fig.width=6, fig.height=4}
p <- spatialRF::plot_residuals_diagnostics(
  model = m,
  point.color = viridis::viridis(n = 100),
  fill.color = viridis::viridis(n = 101)
)
```

### Variable Importance

Variable importance scores reveal which predictors contribute most to the model. Higher values indicate stronger influence on vegetation index predictions.

```{r, fig.width=6, fig.height=4}
spatialRF::plot_importance(
  m = m,
  fill.color = viridis::viridis(n = 100)
)
```

## Conclusion

This article demonstrated how to work with the `vi` dataset:

- Explored the data structure and spatial distribution
- Identified numeric predictors and filtered multicollinearity
- Built a random forest model using `spatialRF`
- Analyzed residuals and variable importance

The `vi` dataset also supports binary classification (`vi_binomial`), count models (`vi_counts`), and ordinal regression (`vi_factor`). Categorical predictors like `continent`, `biogeo_biome`, and `koppen_zone` enable grouped and stratified analyses.

