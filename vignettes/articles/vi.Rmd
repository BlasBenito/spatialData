---
title: "VI: Vegetation Index"
output:
  rmarkdown::html_document:
    toc: true
    toc_title: "Contents"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  eval = TRUE,
  collapse = TRUE,
  comment = "#>",
  out.width = "100%"
)
```

## Overview

The `vi` dataset contains several thousand records of Normalized Difference Vegetation Index (NDVI) with different encodings (see `vi_responses`) and a large set of numeric and categorical predictors (see `vi_predictors`) with consistent naming patterns (e.g., `temperature_*`, `rainfall_*`, `swi_*`).

Its main features are:

- *Complete case study* - No missing values, clean data ready for analysis.
- *Global scope* - 6 continents, all major climate zones, 12 biomes.
- *Scale considerations* - Supports regional, continental, and global analyses.
- *Grouped/stratified analysis* - Multiple hierarchical groupings available.

This dataset was built to support a wide range of analytical approaches:

**Response Variable Modeling**

- *Linear regression* - `vi_numeric` (continuous 0.03-0.82).
- *Count models* (Poisson, negative binomial) - `vi_counts` (integer 30-820).
- *Binary classification / logistic regression* - `vi_binomial` (0/1).
- *Ordinal regression* - `vi_factor` (ordered: very_low â†’ very_high).
- *Multi-class classification* - `vi_categorical` / `vi_factor` (5 levels).

**Statistical and Machine Learning Methods**

- *Multicollinearity selection* - 50+ numeric predictors.
- *Dimensionality reduction* (PCA, UMAP) - High-dimensional predictor space.
- *Random forests / gradient boosting* - Mixed numeric and categorical predictors.
- *Mixed-effects models* - Natural grouping by continent, biome, climate zone.

**Spatial Analysis**

- *Spatial thinning* - `r nrow(vi)` unique global coordinates.
- *Spatial interpolation* (kriging, IDW) - Global coverage with continuous response.
- *Spatial cross-validation* - Stratify by continent, region, biome, or climate.
- *Spatial autocorrelation analysis* - Dense enough for variogram estimation.
- *Geographically weighted regression* (GWR) - Explore spatial non-stationarity.

**Ecological and Environmental Modeling**

- *Species distribution modeling* (SDM) analogues - using `vi_binomial` as response.
- *Climate-vegetation relationships* - Rich climate predictors vs. vegetation index.
- *Soil-vegetation interactions* - Multiple soil variables available.


## Setup

The following R libraries are required to run this tutorial:

```{r, message = FALSE, warning = FALSE, echo = FALSE}
library(spatialData)
library(sf)
library(mapview)
library(DT)
library(dplyr)
library(spatialRF)
library(collinear)
library(viridis)
```

The code below loads the example data.

```{r setup}
data(
  vi,
  vi_responses,
  vi_predictors,
  package = "spatialData"
  )
```

## Data Structure

The dataset is an `sf` data frame with `r nrow(vi)` rows and `r ncol(vi)` columns, and no missing data. The first 10 records and all columns but `geometry` are shown below.

```{r}
DT::datatable(
  data = head(sf::st_drop_geometry(vi), n = 10),
  rownames = FALSE
  )
```

The spatial distribution of the data is irregular, and excludes regions with little to no vegetation activity (`vi$vi_numeric > 0`).


```{r}
mapview::mapview(
  vi,
  zcol = "vi_numeric",
  layer.name = "vi"
)
```



## Response Variables

The dataset provides **5 different encodings** (see `vi_responses`) of the same underlying vegetation index, enabling different modeling approaches:

| Variable | Type | Description | Use Case |
|----------|------|-------------|----------|
| `vi_numeric` | Continuous (0-1) | Raw NDVI values | Linear regression, GAM |
| `vi_counts` | Integer | `vi_numeric * 1000` as integer | Poisson/negative binomial regression |
| `vi_binomial` | Binary (0/1) | Thresholded to 0 or 1 | Logistic regression, classification |
| `vi_categorical` | Character | 5 categories based on quantiles | Multinomial models |
| `vi_factor` | Factor | `vi_categorical` as ordered factor | Ordinal regression |

## Predictor Variables

The dataset includes **58 predictor variables from 11 datasources**, of which 47 are numeric and 11 are categorical.

```{r}
vi |> 
  sf::st_drop_geometry() |> 
  dplyr::select(
    dplyr::all_of(vi_predictors)
  ) |> 
  head(n = 5) |> 
  dplyr::glimpse()
```

## Example Usage

This brief example shows how `vi` can be used to train a random forest model.

### Selection of Numeric Predictors

The `vi_predictors` vector contains both numeric and categorical variables. In this example we focus on the numeric ones, which can be extracted using `collinear::identify_numeric_variables()`.


```{r}
vi_predictors_numeric <- collinear::identify_numeric_variables(
    df = sf::st_drop_geometry(vi),
    predictors = vi_predictors
  )$valid

vi_predictors_numeric
```

### Multicollinearity Filtering

Many predictors in this dataset are highly correlated (e.g., `temperature_mean`, `temperature_max`, `temperature_min`). The `collinear::collinear()` function selects a non-redundant subset that maximizes predictive power for the response variable.

```{r}
predictors_selection <- collinear::collinear(
  df = vi,
  responses = "vi_numeric",
  predictors = vi_predictors_numeric,
  f = collinear::f_numeric_rf,
  quiet = TRUE
)

predictors_selection$vi_numeric$selection
```

### Random Forest Model

The response `vi_numeric` and the selected predictors are used below to train a random forest model.

```{r}
m <- spatialRF::rf(
  data = sf::st_drop_geometry(vi),
  dependent.variable.name = "vi_numeric",
  predictor.variable.names = predictors_selection$vi_numeric$selection,
  verbose = FALSE
)

spatialRF::print_performance(model = m)
```

### Global Variable Importance

The permutation importance plot below indicates the variables that increase model errors the most when permuted.


```{r, fig.width=6, fig.height=4}
spatialRF::plot_importance(
  m = m,
  fill.color = viridis::viridis(n = 100)
)
```

### Local Variable Importance

The code below assigns to each observation the name of the predictor that matters most for that specific location's prediction, revealing geographic patterns in variable relevance.

```{r}
local_importance <- m$importance$local
vi$most_local_importance <- colnames(local_importance)[max.col(local_importance)]

mapview::mapview(
  vi,
  zcol = "most_local_importance",
  layer.name = "Most important predictor",
  col.regions = viridis::turbo(n = length(unique(vi$most_local_importance)))
)
```

### Response Curves and Surfaces

The response curves below show how the response `vi_numeric` changes across the values of the most important predictors when all other predictors are set to their quantile 0.5.


```{r}
spatialRF::plot_response_curves(
  model = m,
  quantiles = 0.5
)
```
Finally, the response surface below shows how `rainfall_mean` and `soil_temperature_max` interact with each other to predict `vi_numeric`. The grey dots represent the actual observations of `vi_numeric`.


```{r}
spatialRF::plot_response_surface(
  m = m,
  a = "rainfall_mean",
  b = "soil_temperature_max",
  fill.color = viridis::viridis(n = 100),
  point.alpha = 0.2,
  point.size.range = c(0.1, 1.5)
)
```

The usage example above is only one of the many modeling approaches that can be applied to `vi`. The dataset also supports binary classification (`vi_binomial`), count models (`vi_counts`), and ordinal regression (`vi_factor`). Categorical predictors like `continent`, `biogeo_biome`, and `koppen_zone` enable grouped and stratified analyses.
