---
title: "Plantae: Plant Diversity Metrics for Global Ecoregions"
output:
  rmarkdown::html_document:
    toc: true
    toc_title: "Contents"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  eval = TRUE,
  collapse = TRUE,
  comment = "#>",
  out.width = "100%"
)
```

## Overview

The `plantae` dataset contains plant diversity metrics for **662 global ecoregions** derived from GBIF Plantae occurrence records. Metrics are computed at multiple taxonomic levels (species, genera, families) for all plants, trees, and grasses.

Key features:

- *Global scope* - 662 ecoregions across all continents and major biomes.
- *Multiple taxonomic levels* - Species, genus, and family-level metrics.
- *Comprehensive diversity metrics* - Richness, rarity-weighted richness, mean rarity, and three beta diversity indices.
- *Taxonomic subsets* - Separate metrics for trees and grasses.
- *Rich predictor set* - 96 environmental, geographic, and human impact predictors.

This dataset supports a variety of analytical approaches:

**Macroecological Studies**

- Species-area relationships at the ecoregion scale.
- Latitudinal diversity gradients.
- Climate-biodiversity relationships.

**Beta Diversity Analysis**

- Compositional turnover patterns using Sorensen, Simpson, and raw turnover metrics.
- Community differentiation across biomes and realms.

**Conservation Applications**

- Identifying hotspots of plant diversity and endemism.
- Assessing human impact on plant communities.
- Prioritization based on rarity-weighted metrics.

## Setup

The following R libraries are required:

```{r, message = FALSE, warning = FALSE, echo = FALSE}
library(spatialData)
library(sf)
library(mapview)
library(DT)
library(dplyr)
library(collinear)
```

Load the dataset and helper vectors:

```{r setup}
data(
  plantae,
  plantae_responses,
  plantae_predictors,
  package = "spatialData"
)
```

## Data Structure

The dataset is an `sf` data frame with `r nrow(plantae)` rows (ecoregions) and `r ncol(plantae)` columns. Point geometries represent ecoregion centroids in WGS84. The first 100 records are shown below:

```{r}
DT::datatable(
  data = head(sf::st_drop_geometry(plantae), n = 100),
  rownames = FALSE,
  options = list(scrollX = TRUE)
)
```

The spatial distribution of ecoregions, colored by species richness:

```{r}
mapview::mapview(
  plantae,
  zcol = "richness_species",
  layer.name = "Species Richness"
)
```

## Response Variables

The dataset provides **53 response variables** organized into six categories. All metrics are available for all plants, with many also computed separately for trees and grasses.

### Richness (9 variables)

Simple counts of taxa present in each ecoregion:

| Variable | Description |
|----------|-------------|
| `richness_species` | Number of plant species |
| `richness_genera` | Number of plant genera |
| `richness_families` | Number of plant families |
| `richness_classes` | Number of plant classes |
| `richness_species_trees` | Number of tree species |
| `richness_genera_trees` | Number of tree genera |
| `richness_families_trees` | Number of tree families |
| `richness_species_grasses` | Number of grass species |
| `richness_genera_grasses` | Number of grass genera |

### Rarity-Weighted Richness (6 variables)

Richness weighted by the inverse of each taxon's range size (Williams et al. 1996), giving higher weight to range-restricted taxa:

| Variable | Description |
|----------|-------------|
| `rarity_weighted_richness_species` | Rarity-weighted richness for species |
| `rarity_weighted_richness_genera` | Rarity-weighted richness for genera |
| `rarity_weighted_richness_species_trees` | Rarity-weighted richness for tree species |
| `rarity_weighted_richness_genera_trees` | Rarity-weighted richness for tree genera |
| `rarity_weighted_richness_species_grasses` | Rarity-weighted richness for grass species |
| `rarity_weighted_richness_genera_grasses` | Rarity-weighted richness for grass genera |

### Mean Rarity (6 variables)

Average rarity index across all taxa in the ecoregion:

| Variable | Description |
|----------|-------------|
| `mean_rarity_species` | Mean rarity index for species |
| `mean_rarity_genera` | Mean rarity index for genera |
| `mean_rarity_species_trees` | Mean rarity index for tree species |
| `mean_rarity_genera_trees` | Mean rarity index for tree genera |
| `mean_rarity_species_grasses` | Mean rarity index for grass species |
| `mean_rarity_genera_grasses` | Mean rarity index for grass genera |

### Beta Diversity - Raw Turnover (16 variables)

Raw compositional turnover counts and percentages relative to neighboring ecoregions:

| Variable | Description |
|----------|-------------|
| `betadiversity_R_species` | Raw turnover count for species |
| `betadiversity_R_percent_species` | Raw turnover percentage for species |
| `betadiversity_R_genera` | Raw turnover count for genera |
| `betadiversity_R_percent_genera` | Raw turnover percentage for genera |
| `betadiversity_R_families` | Raw turnover count for families |
| `betadiversity_R_percent_families` | Raw turnover percentage for families |
| ... | Additional metrics for trees and grasses |

### Beta Diversity - Sorensen (8 variables)

Sorensen dissimilarity index measuring compositional differences with neighbors:

| Variable | Description |
|----------|-------------|
| `betadiversity_sorensen_species` | Sorensen dissimilarity for species |
| `betadiversity_sorensen_genera` | Sorensen dissimilarity for genera |
| `betadiversity_sorensen_families` | Sorensen dissimilarity for families |
| ... | Additional metrics for trees and grasses |

### Beta Diversity - Simpson (8 variables)

Simpson dissimilarity index (turnover component, independent of richness differences):

| Variable | Description |
|----------|-------------|
| `betadiversity_simpson_species` | Simpson dissimilarity for species |
| `betadiversity_simpson_genera` | Simpson dissimilarity for genera |
| `betadiversity_simpson_families` | Simpson dissimilarity for families |
| ... | Additional metrics for trees and grasses |

## Predictor Variables

The dataset includes **96 predictor variables** from 12 thematic categories:

| Category | Count | Examples |
|----------|-------|----------|
| Sampling bias | 7 | `bias_records`, `bias_sampling` |
| Geographic | 14 | `geo_area_km2`, `geo_elevation_mean`, `geo_latitude_mean` |
| Human impact | 5 | `human_population_density`, `human_footprint_mean` |
| Climate change | 2 | `climate_velocity_lgm_mean`, `climate_hypervolume` |
| Landcover | 3 | `landcover_trees_percent_mean`, `landcover_herbs_percent_mean` |
| Fragmentation | 19 | `fragmentation_cohesion`, `fragmentation_division`, `fragmentation_ed` |
| Atmospheric | 13 | `aridity_mean`, `air_humidity_mean`, `evapotranspiration_mean` |
| Precipitation | 8 | `precipitation_total`, `precipitation_seasonality` |
| Temperature | 11 | `temperature_mean`, `temperature_range`, `temperature_seasonality` |
| Soil | 6 | `soil_ph`, `soil_nitrogen`, `soil_organic_carbon` |
| Soil temperature | 4 | `soil_temperature_mean`, `soil_temperature_range` |
| NDVI | 4 | `ndvi_mean`, `ndvi_range` |

Overview of predictor structure:

```{r}
plantae |>
  sf::st_drop_geometry() |>
  dplyr::select(dplyr::all_of(plantae_predictors)) |>
  head(n = 5) |>
  dplyr::glimpse()
```

## Example Usage

This example demonstrates a linear model predicting plant species richness from environmental predictors.

### Select Numeric Predictors

Extract numeric predictors for multicollinearity analysis:

```{r}
predictors_numeric <- collinear::identify_numeric_variables(
  df = sf::st_drop_geometry(plantae),
  predictors = plantae_predictors
)$valid

length(predictors_numeric)
```

### Filter Multicollinearity

Many predictors are highly correlated (e.g., `temperature_mean`, `temperature_warmest_quarter`). The `collinear()` function selects a non-redundant subset optimized for the response:

```{r}
predictors_selected <- collinear::collinear(
  df = plantae,
  responses = "richness_species",
  predictors = predictors_numeric,
  f = collinear::f_numeric_rf,
  quiet = TRUE
)

predictors_selected$richness_species$selection
```

### Scatterplots

Visualize the relationship between species richness and selected predictors:

```{r, fig.width = 8, fig.height = 6}
df_plot <- sf::st_drop_geometry(plantae)
selected_vars <- predictors_selected$richness_species$selection

par(mfrow = c(2, 3), mar = c(4, 4, 2, 1))
for (var in selected_vars[1:min(6, length(selected_vars))]) {
  plot(
    x = df_plot[[var]],
    y = df_plot$richness_species,
    xlab = var,
    ylab = "richness_species",
    pch = 16,
    col = adjustcolor("steelblue", 0.5),
    main = var
  )
  lines(lowess(df_plot[[var]], df_plot$richness_species), col = "red", lwd = 2)
}
```

### Fit Linear Model

Build a linear model using the selected predictors:

```{r}
formula_lm <- as.formula(
  paste("richness_species ~", paste(selected_vars, collapse = " + "))
)

model_lm <- lm(
  formula = formula_lm,
  data = sf::st_drop_geometry(plantae)
)

summary(model_lm)
```

### Diagnostic Plots

Assess model assumptions with diagnostic plots:

```{r, fig.width = 8, fig.height = 6}
par(mfrow = c(2, 2))
plot(model_lm)
```

## Conclusion

This article demonstrated how to work with the `plantae` dataset:

- Explored the data structure with 662 ecoregions and 155 variables.
- Reviewed 53 response variables covering richness, rarity, and beta diversity.
- Examined 96 predictor variables across 12 environmental categories.
- Built a linear model for species richness after multicollinearity filtering.

The dataset supports many additional analyses:

- **Other response variables:** Model beta diversity (`betadiversity_sorensen_*`) or rarity-weighted richness (`rarity_weighted_richness_*`) for different ecological questions.
- **Taxonomic focus:** Use tree-specific (`*_trees`) or grass-specific (`*_grasses`) metrics for functional group analyses.
- **Stratified analysis:** Group by `ecoregion_biome` or `ecoregion_realm` for regional studies.
- **Spatial models:** The `sf` geometry enables spatial regression and autocorrelation analysis.
